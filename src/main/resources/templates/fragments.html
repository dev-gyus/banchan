<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:fragment="commonHead">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>반찬의민족</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="/node_modules/cropperjs/dist/cropper.min.css">
    <link rel="stylesheet" href="/node_modules/@fortawesome/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="/node_modules/@yaireo/tagify/dist/tagify.css">
    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>
    <script src="/node_modules/jdenticon/dist/jdenticon.min.js"></script>
    <script src="/node_modules/cropperjs/dist/cropper.min.js"></script>
    <script src="/node_modules/jquery-cropper/dist/jquery-cropper.min.js"></script>
    <script src="/node_modules/@fortawesome/fontawesome-free/js/all.min.js"></script>
    <script src="/node_modules/@yaireo/tagify/dist/tagify.min.js"></script>
    <style>
        body {
            font-family: 'Jua', sans-serif;
            font-size: 20px;
        }
    </style>
</head>

<div th:fragment="commonNav">
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">반찬의민족</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/storelist}">주문하기</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            소개
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">사업소개</a></li>
                            <li><a class="dropdown-item" href="#">회사소개</a></li>
                            <li><a class="dropdown-item" href="#">비전</a></li>
                        </ul>
                    </li>
                </ul>

                <div data-bs-toggle="tooltip" data-bs-placement="bottom" title="마이페이지" th:if="${navAccount != null && #authorization.expr('isAuthenticated()') && navAccount.role == T(com.devgyu.banchan.account.Roles).ROLE_USER}">
                    <div th:replace="fragments :: profileImage ('/mypage')"></div>
                </div>
                <div data-bs-toggle="tooltip" data-bs-placement="bottom" title="마이페이지" th:if="${navAccount != null && #authorization.expr('isAuthenticated()') && navAccount.role == T(com.devgyu.banchan.account.Roles).ROLE_USER}">
                    <div th:replace="fragments :: profileNickname ('/mypage')"></div>
                </div>

                <div data-bs-toggle="tooltip" data-bs-placement="bottom" title="내 가게정보" th:if="${navAccount != null && #authorization.expr('isAuthenticated()') && navAccount.role == T(com.devgyu.banchan.account.Roles).ROLE_OWNER}">
                    <div th:replace="fragments :: profileImage ('/mystore')"></div>
                </div>
                <div data-bs-toggle="tooltip" data-bs-placement="bottom" title="내 가게정보" th:if="${navAccount != null && #authorization.expr('isAuthenticated()') && navAccount.role == T(com.devgyu.banchan.account.Roles).ROLE_OWNER}">
                    <div th:replace="fragments :: profileNickname ('/mystore')"></div>
                </div>

                <div data-bs-toggle="tooltip" data-bs-placement="bottom" title="마이페이지" th:if="${navAccount != null && #authorization.expr('isAuthenticated()') && navAccount.role == T(com.devgyu.banchan.account.Roles).ROLE_RIDER}">
                    <div th:replace="fragments :: profileImage ('/rider/rider-page')"></div>
                </div>
                <div data-bs-toggle="tooltip" data-bs-placement="bottom" title="마이페이지" th:if="${navAccount != null && #authorization.expr('isAuthenticated()') && navAccount.role == T(com.devgyu.banchan.account.Roles).ROLE_RIDER}">
                    <div th:replace="fragments :: profileNickname ('/rider/rider-page')"></div>
                </div>

                <div th:if="${navAccount != null && #authorization.expr('isAuthenticated()')}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="주문확인">
                    <span class="position-relative me-2" >
                        <a th:href="@{/orders}" class="stretched-link"></a>
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </span>
                </div>
                <div th:if="${navAccount != null && #authorization.expr('isAuthenticated()')}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="장바구니">
                    <span class="position-relative me-2" >
                        <a th:href="@{/cart}" class="stretched-link"></a>
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </span>
                </div>

                <script>
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl)
                    })
                </script>
                <div th:if="${navAccount == null}">
                    <a class="btn btn-outline-success me-1" th:href="@{/register}">회원가입</a>
                    <a class="btn btn-outline-primary" th:href="@{/login}">로그인</a>
                </div>
                <div th:if="${navAccount != null && #authorization.expr('isAuthenticated()')}">
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="btn btn-outline-danger">로그아웃</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>
</div>

<div class="me-2 position-relative" th:fragment="profileImage(mypageUrl)">
    <svg class="rounded-circle" th:if="${navAccount.thumbnail == null}"
         th:data-jdenticon-value="${navAccount.name}" th:width="60" th:height="60">
        Fallback text or image for browsers not supporting inline svg.
    </svg>
    <img class="rounded-circle" th:if="${navAccount.thumbnail != null}"
         th:src="${navAccount.thumbnail}" th:width="60">
    <a th:href="@{${mypageUrl}}" class="stretched-link"></a>
</div>

<div class="me-2 position-relative" th:fragment="profileNickname(mypageUrl)">
    <div th:text="${navAccount.nickname} + '님 어서오세요!'"></div>
    <a th:href="@{${mypageUrl}}" class="stretched-link"></a>
</div>
</div>

<script th:fragment="phone-validate">
    let phone = document.getElementById('phone');
    document.addEventListener('DOMContentLoaded', function (){
        phone.addEventListener('change',function(){
            let regExp = /^\d{10,11}$/;
            if(!regExp.exec(phone.value)){
                $('#phone-error').show();
            }
        })
    });
</script>

<script th:fragment="tel-validate">
    let tel = document.getElementById('tel');
    document.addEventListener('DOMContentLoaded', function (){
        tel.addEventListener('change',function(){
            let regExp = /^\d{9,11}$/;
            if(!regExp.exec(tel.value)){
                $('#tel-error').show();
            }else if(regExp.exec(tel.value)){
                $('#tel-error').hide();
            }
        })
    });
</script>

<script th:fragment="form-validate">
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }

                    form.classList.add('was-validated')
                }, false)
            })
    })()
</script>

<div th:fragment="addressJavaScript">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        //본 예제에서는 도로명 주소 표기 방식에 대한 법령에 따라, 내려오는 데이터를 조합하여 올바른 주소를 구성하는 방법을 설명합니다.
        function sample4_execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                    // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
                    // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                    var roadAddr = data.roadAddress; // 도로명 주소 변수
                    var extraRoadAddr = ''; // 참고 항목 변수

                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraRoadAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if (extraRoadAddr !== '') {
                        extraRoadAddr = ' (' + extraRoadAddr + ')';
                    }

                    // 우편번호와 주소 정보를 해당 필드에 넣는다.
                    document.getElementById('sample4_postcode').value = data.zonecode;
                    document.getElementById("sample4_roadAddress").value = roadAddr;
                    document.getElementById("sample4_jibunAddress").value = data.jibunAddress;

                    // 참고항목 문자열이 있을 경우 해당 필드에 넣는다.
                    if (roadAddr !== '') {
                        document.getElementById("sample4_extraAddress").value = extraRoadAddr;
                    } else {
                        document.getElementById("sample4_extraAddress").value = '';
                    }
                }
            }).open();
        }
    </script>
</div>

<script th:fragment="cropperjs(isRounded)" type="application/javascript">
    $(function () {
        cropper = '';
        let $confirmBtn = $("#confirm-button");
        let $resetBtn = $("#reset-button");
        let $cutBtn = $("#cut-button");
        let $newProfileImage = $("#new-profile-image");
        let $currentProfileImage = $("#current-profile-image");
        let $resultImage = $("#cropped-new-profile-image");
        let $profileImage = $("#profileImage");
        let rounded = 'rounded-circle';
        let isRounded = '[[${isRounded}]]';
        if(isRounded == 'false'){
            rounded = 'rounded-3';
        }

        $newProfileImage.hide();
        $cutBtn.hide();
        $resetBtn.hide();
        $confirmBtn.hide();

        $("#profile-image-file").change(function (e) {
            if (e.target.files.length === 1) {
                const reader = new FileReader();
                reader.onload = e => {
                    if (e.target.result) {
                        if (!e.target.result.startsWith("data:image")) {
                            alert("이미지 파일을 선택하세요.");
                            return;
                        }

                        let img = document.createElement("img");
                        img.id = 'new-profile';
                        img.src = e.target.result;
                        img.setAttribute('width', '100%');

                        $newProfileImage.html(img);
                        $newProfileImage.show();

                        let $newImage = $(img);
                        $newImage.cropper({aspectRatio: 1});
                        cropper = $newImage.data('cropper');

                        $cutBtn.show();
                        $confirmBtn.hide();
                        $resetBtn.show();
                    }
                };

                reader.readAsDataURL(e.target.files[0]);
            }
        });

        $resetBtn.click(function () {
            $currentProfileImage.show();
            $newProfileImage.hide();
            $resultImage.hide();
            $resetBtn.hide();
            $cutBtn.hide();
            $confirmBtn.hide();
            $profileImage.val('');
            $("#profile-image-file").val('');
        });

        $cutBtn.click(function () {
            let dataUrl = cropper.getCroppedCanvas().toDataURL();

            if (dataUrl.length > 1000 * 1024) {
                alert("이미지 파일이 너무 큽니다. 1024000 보다 작은 파일을 사용하세요. 현재 이미지 사이즈 " + dataUrl.length);
                return;
            }

            let newImage = document.createElement("img");
            newImage.id = "cropped-new-profile-image";
            newImage.src = dataUrl;
            newImage.width = 125;
            newImage.setAttribute("class", rounded);
            $resultImage.html(newImage);
            $resultImage.show();
            $confirmBtn.show();

            $confirmBtn.click(function () {
                $currentProfileImage.hide();
                $newProfileImage.html(newImage);
                $cutBtn.hide();
                $confirmBtn.hide();
                $profileImage.val(dataUrl);
            });
        });
    });
</script>

<span th:fragment="accountThumbnail (accountObject, size, isRounded)">
    <svg th:classappend="${isRounded == true} ? 'rounded-circle' : 'rounded-3'" th:id="current-profile-image" th:if="${accountObject.thumbnail == null}"
         th:data-jdenticon-value="${accountObject.name}" th:width="${size}" th:height="${size}">
        Fallback text or image for browsers not supporting inline svg.
    </svg>
    <img th:classappend="${isRounded == true} ? 'rounded-circle' : 'rounded-3'" th:if="${accountObject.thumbnail != null}" th:id="current-profile-image"
         th:src="${accountObject.thumbnail}" th:width="${size}">
</span>

</html>